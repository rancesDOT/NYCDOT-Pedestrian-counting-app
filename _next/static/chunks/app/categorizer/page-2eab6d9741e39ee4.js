(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[256],{9887:function(e,t,n){Promise.resolve().then(n.bind(n,7049))},7049:function(e,t,n){"use strict";n.d(t,{default:function(){return v}});var a=n(7437),r=n(2265),o=n(6165),l=n(8873),i=n(3117),c=n(4238),s=n(4693),u=n(5659),d=n(1749),m=n(4635);let g=m.hj.reduce((e,t)=>({...e,[t.name]:0}),{}),h="pedestrian-counter-data";function v(){let[e,t]=(0,r.useState)(g),[n,v]=(0,r.useState)([]),[f,p]=(0,r.useState)(null),[S,b]=(0,r.useState)(null),[k,y]=(0,r.useState)(!1),[C,x]=(0,r.useState)(1),[T,j]=(0,r.useState)([]),[E,w]=(0,r.useState)(!1),[I,L]=(0,r.useState)([]),[O,D]=(0,r.useState)(!1),[M,R]=(0,r.useState)(!1),[U,N]=(0,r.useState)(!1),[P,_]=(0,r.useState)(null),[V,F]=(0,r.useState)(!1),[Z,H]=(0,r.useState)(!1),[A,J]=(0,r.useState)(null),[B,z]=(0,r.useState)(!1),[K,q]=(0,r.useState)(1),[G,Q]=(0,r.useState)(0),[W,X]=(0,r.useState)(0),[Y,$]=(0,r.useState)(0),ee=(0,r.useRef)(null),et=(0,r.useRef)(null),en=(0,r.useCallback)(()=>{try{var t;let a={counts:e,log:n,videoSrc:f,intersections:T,playbackRate:C,currentTime:(null===(t=ee.current)||void 0===t?void 0:t.currentTime)||W,duration:Y,lastSaved:Date.now(),recordingStartTime:null==A?void 0:A.toISOString(),videoCount:K,currentVideoIndex:G};localStorage.setItem(h,JSON.stringify(a)),console.log("Data saved to localStorage")}catch(e){console.error("Failed to save data to localStorage:",e)}},[e,n,f,T,C,W,Y,A,K,G]),ea=(0,r.useCallback)(()=>{try{let e=localStorage.getItem(h);if(e){let n=JSON.parse(e);if(Date.now()-n.lastSaved>6048e5)return console.log("Saved data is too old, starting fresh"),localStorage.removeItem(h),!1;if(n.videoSrc&&(n.log.length>0||n.intersections.length>0))return _(n),N(!0),t(n.counts||g),v(n.log||[]),j(n.intersections||[]),x(n.playbackRate||1),X(n.currentTime||0),$(n.duration||0),J(n.recordingStartTime?new Date(n.recordingStartTime):null),q(n.videoCount||1),Q(n.currentVideoIndex||0),!0;return t(n.counts||g),v(n.log||[]),p(n.videoSrc||null),j(n.intersections||[]),x(n.playbackRate||1),X(n.currentTime||0),$(n.duration||0),J(n.recordingStartTime?new Date(n.recordingStartTime):null),q(n.videoCount||1),Q(n.currentVideoIndex||0),console.log("Data loaded from localStorage"),!0}}catch(e){console.error("Failed to load data from localStorage:",e),localStorage.removeItem(h)}return!1},[]),er=(0,r.useCallback)(()=>{try{localStorage.removeItem(h),console.log("Saved data cleared")}catch(e){console.error("Failed to clear saved data:",e)}},[]),eo=(0,r.useCallback)(e=>{P&&(p(URL.createObjectURL(e)),F(!0),N(!1))},[P]),el=(0,r.useCallback)(()=>{N(!1),_(null),er()},[er]);(0,r.useEffect)(()=>{ea(),R(!0)},[ea]),(0,r.useEffect)(()=>{if(M)return en(),et.current&&clearInterval(et.current),et.current=setInterval(en,5e3),()=>{et.current&&clearInterval(et.current)}},[e,n,f,T,C,en,M,A,K,G]),(0,r.useEffect)(()=>{let e=()=>{en()},t=()=>{"hidden"===document.visibilityState&&en()};return window.addEventListener("beforeunload",e),document.addEventListener("visibilitychange",t),()=>{window.removeEventListener("beforeunload",e),document.removeEventListener("visibilitychange",t)}},[en]),(0,r.useEffect)(()=>{let e=ee.current;if(!e)return;let t=()=>{y(!1),z(!0)};return e.addEventListener("ended",t),()=>{e.removeEventListener("ended",t)}},[f]);let ei=(0,r.useCallback)(e=>{if(0===e.length)return[];let t={},n={};return e.forEach(e=>{n[e.videoIndex]||(n[e.videoIndex]=[]),n[e.videoIndex].push(e)}),Object.entries(n).forEach(e=>{let[n,a]=e,r=Number.parseInt(n),o=a.map(e=>e.timestamp),l=15*Math.floor(Math.min(...o)/15),i=15*Math.floor(Math.max(...o)/15);for(let e=l;e<=i;e+=15){let n,a,o;let l=e+15,i="".concat(r,"-").concat(e);if(A){a=new Date(A.getTime()+1e3*e),o=new Date(A.getTime()+1e3*l);let t=a.toLocaleTimeString("en-US",{hour12:!1,hour:"2-digit",minute:"2-digit",second:"2-digit"}),r=o.toLocaleTimeString("en-US",{hour12:!1,hour:"2-digit",minute:"2-digit",second:"2-digit"});n="".concat(t," - ").concat(r)}else{let t=Math.floor(e/60),a=Math.floor(e%60),r=Math.floor(l/60),o=Math.floor(l%60);n="".concat(t,":").concat(a.toString().padStart(2,"0"),"-").concat(r,":").concat(o.toString().padStart(2,"0"))}t[i]={interval:n,startTime:e,endTime:l,directions:m.hj.reduce((e,t)=>({...e,[t.name]:0}),{}),totalCount:0,actualStartTime:a,actualEndTime:o,videoIndex:r}}a.forEach(e=>{let n=15*Math.floor(e.timestamp/15),a="".concat(e.videoIndex,"-").concat(n),r=m.hj.find(t=>t.key===e.key);r&&t[a]&&(t[a].directions[r.name]++,t[a].totalCount++)})}),Object.values(t).sort((e,t)=>e.videoIndex!==t.videoIndex?e.videoIndex-t.videoIndex:e.startTime-t.startTime)},[A]),ec=(0,r.useCallback)(n=>{var a,r;let o=m.hj.find(e=>e.key===n);if(!o||!f||4!==T.length)return;let l=null!==(r=null===(a=ee.current)||void 0===a?void 0:a.currentTime)&&void 0!==r?r:0;v(e=>[...e,{key:n,timestamp:l,videoIndex:G}]);let i=(e[o.name]||0)+1;t(e=>({...e,[o.name]:i})),b({key:n,direction:o.direction})},[e,f,T.length,G]),es=(0,r.useCallback)(()=>{if(0===n.length){b(null);return}let e=n[n.length-1],a=m.hj.find(t=>t.key===e.key);a&&t(e=>({...e,[a.name]:Math.max(0,e[a.name]-1)}));let r=n.slice(0,-1);if(v(r),r.length>0){let e=r[r.length-1],t=m.hj.find(t=>t.key===e.key);t?b({key:e.key,direction:t.direction}):b(null)}else b(null)},[n]),eu=(0,r.useCallback)(()=>{p(null),j([]),t(g),v([]),y(!1),x(1),b(null),X(0),$(0),J(null),q(1),Q(0),er()},[er]),ed=(0,r.useCallback)((e,t)=>{try{let n=e.map(e=>{let t=[1,2,3,4,5,6,7,8].map(t=>{let n=m.hj.find(e=>e.key===t.toString());return n&&e.directions[n.name]||0});return[e.interval,...t].join(",")}),a=["Time interval,1,2,3,4,5,6,7,8",...n].join("\n"),r=new Blob([a],{type:"text/csv;charset=utf-8;"}),o=document.createElement("a"),l=URL.createObjectURL(r);o.setAttribute("href",l),o.setAttribute("download",t),o.style.visibility="hidden",document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(l)}catch(e){console.error("Error downloading CSV:",e)}},[]),em=(0,r.useCallback)(()=>{0!==n.length&&(L(ei(n)),w(!0))},[n,ei]),eg=(0,r.useCallback)(()=>{if(w(!1),I.length>0){let e;let t=new Date().toISOString().slice(0,19).replace(/:/g,"-");if(A){let n=A.toISOString().slice(0,10);e="pedestrian_counts_".concat(n,"_").concat(t,".csv")}else e="pedestrian_counts_video_time_".concat(t,".csv");ed(I,e)}},[I,ed,A]),eh=(0,r.useCallback)(()=>{if(ee.current)try{ee.current.paused?ee.current.play():ee.current.pause()}catch(e){console.error("Error toggling video playback:",e)}},[]),ev=(0,r.useCallback)(e=>{if(ee.current)try{let t=Math.max(.25,Math.min(4,e));ee.current.playbackRate=t,x(t)}catch(e){console.error("Error changing playback rate:",e)}},[]),ef=(0,r.useCallback)(e=>{p(e),j([]),e&&(y(!1),x(1),X(0),$(0),b(null),J(null),H(!0))},[]),ep=(0,r.useCallback)(()=>{z(!1),Q(K),q(e=>e+1);let e=document.getElementById("video-upload-hidden");null==e||e.click()},[K]),eS=(0,r.useCallback)(()=>{z(!1),em()},[em]),eb=(0,r.useCallback)(()=>{z(!1),ee.current&&(ee.current.currentTime=0,X(0))},[]),ek=(0,r.useCallback)(e=>{J(e),H(!1)},[]),ey=(0,r.useCallback)(()=>{J(null),H(!1)},[]),eC=(0,r.useCallback)(()=>{ee.current&&X(ee.current.currentTime)},[]),ex=(0,r.useCallback)(()=>{if(ee.current){if($(ee.current.duration),V&&P){let e=P.currentTime;e&&e>0&&(ee.current.currentTime=e,X(e),console.log("Video restored to time: ".concat(e,"s"))),F(!1),_(null)}else{let e=localStorage.getItem(h);if(e)try{let t=JSON.parse(e);t.currentTime&&t.currentTime>0&&!t.videoSrc&&(ee.current.currentTime=t.currentTime,X(t.currentTime))}catch(e){console.error("Failed to restore video time on fresh load:",e)}}}},[V,P]),eT=(0,r.useCallback)(e=>{ee.current&&(ee.current.currentTime=e,X(e))},[]),ej=(0,r.useCallback)(()=>{D(!0)},[]);if((0,r.useEffect)(()=>{let e=e=>{var t;if(e.target instanceof HTMLInputElement||e.target instanceof HTMLTextAreaElement||e.target instanceof HTMLSelectElement||(null===(t=e.target)||void 0===t?void 0:t.closest("input, textarea, select, [contenteditable]")))return;let n=e.key.toLowerCase(),a=e.key.replace("numpad","");m.hj.some(e=>e.key===a)&&4===T.length?(e.preventDefault(),e.stopPropagation(),ec(a)):"z"===n?(e.preventDefault(),e.stopPropagation(),es()):" "===n&&f?(e.preventDefault(),e.stopPropagation(),eh()):"?"===n||e.shiftKey&&"/"===n?(e.preventDefault(),e.stopPropagation(),D(e=>!e)):"arrowleft"===n&&f?(e.preventDefault(),e.stopPropagation(),ev(Math.max(.25,C-.25))):"arrowright"===n&&f&&(e.preventDefault(),e.stopPropagation(),ev(Math.min(4,C+.25)))};return document.addEventListener("keydown",e,{capture:!1}),()=>{document.removeEventListener("keydown",e,{capture:!1})}},[ec,es,f,eh,T.length,C,ev]),!M)return(0,a.jsx)("div",{className:"h-screen w-screen bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-800 flex items-center justify-center",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),(0,a.jsx)("p",{className:"text-slate-600 dark:text-slate-300",children:"Loading saved data..."})]})});let eE=Object.values(e).reduce((e,t)=>e+t,0),ew=S?(()=>{let t=m.hj.find(e=>e.key===S.key);return t&&e[t.name]||0})():0;return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("main",{className:"h-screen w-screen bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-800 flex flex-col p-4 gap-0 overflow-hidden transition-all duration-300 ".concat(O?"pr-84":""),children:[(0,a.jsx)("div",{className:"flex-grow h-full min-h-0",children:(0,a.jsx)(o.Z,{ref:ee,videoSrc:f,onVideoSelect:ef,onPlay:()=>y(!0),onPause:()=>y(!1),lastPressed:S,onIntersectionsSet:j,onTimeUpdate:eC,onLoadedMetadata:ex})}),(0,a.jsx)("div",{className:"flex-shrink-0",children:(0,a.jsx)(l.Z,{isPlaying:k,playbackRate:C,onTogglePlay:eh,onChangePlaybackRate:ev,isVideoLoaded:!!f,onUndo:es,onFinish:em,onClearVideo:eu,canUndo:n.length>0,canFinish:n.length>0,currentTime:W,duration:Y,onSeek:eT,onShowHelp:ej,lastPressed:S,intersectionsSet:4===T.length,totalCount:eE,lastDirectionCount:ew})})]}),(0,a.jsx)(u.Z,{isOpen:Z,onConfirm:ek,onSkip:ey}),(0,a.jsx)(d.Z,{isOpen:B,onUploadNew:ep,onExport:eS,onReplay:eb,totalCounts:eE,videoCount:K}),(0,a.jsx)(i.Z,{isOpen:E,onComplete:eg,totalEntries:n.length,groupedEntries:I.length}),(0,a.jsx)(c.Z,{isOpen:O,onClose:()=>D(!1),onCount:ec,onUndo:es,intersectionsSet:4===T.length,canUndo:n.length>0}),U&&P&&(0,a.jsx)(s.Z,{isOpen:U,onVideoRestore:eo,onDismiss:el,savedData:{currentTime:P.currentTime,duration:P.duration,totalCounts:eE,intersectionCount:P.intersections.length,lastSaved:P.lastSaved}}),(0,a.jsx)("input",{type:"file",id:"video-upload-hidden",accept:"video/mp4, video/webm, video/ogg",style:{display:"none"},onChange:e=>{var t;let n=null===(t=e.target.files)||void 0===t?void 0:t[0];n&&ef(URL.createObjectURL(n)),e.target.value=""}})]})}}},function(e){e.O(0,[533,367,971,117,744],function(){return e(e.s=9887)}),_N_E=e.O()}]);