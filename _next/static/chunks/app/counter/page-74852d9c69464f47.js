(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[242],{1214:function(e,t,n){Promise.resolve().then(n.bind(n,1074))},1074:function(e,t,n){"use strict";n.d(t,{default:function(){return v}});var r=n(7437),o=n(2265),a=n(6165),l=n(8873),i=n(3117),c=n(4238),s=n(4693),u=n(5659),d=n(1749),g=n(4635);let m=g.hj.reduce((e,t)=>({...e,[t.name]:0}),{}),h="pedestrian-counter-data",f={INTERVAL_SIZE_SECONDS:60};function v(){let[e,t]=(0,o.useState)(m),[n,v]=(0,o.useState)([]),[S,p]=(0,o.useState)(null),[b,k]=(0,o.useState)(null),[C,y]=(0,o.useState)(!1),[x,T]=(0,o.useState)(1),[E,w]=(0,o.useState)([]),[j,I]=(0,o.useState)(!1),[L,N]=(0,o.useState)([]),[O,R]=(0,o.useState)(!1),[D,M]=(0,o.useState)(!1),[_,V]=(0,o.useState)(!1),[U,P]=(0,o.useState)(null),[Z,A]=(0,o.useState)(!1),[F,H]=(0,o.useState)(!1),[J,B]=(0,o.useState)(null),[G,q]=(0,o.useState)(!1),[z,K]=(0,o.useState)(1),[Q,W]=(0,o.useState)(0),[X,Y]=(0,o.useState)({}),[$,ee]=(0,o.useState)(!1),[et,en]=(0,o.useState)(0),[er,eo]=(0,o.useState)(0),ea=(0,o.useRef)(null),el=(0,o.useRef)(null),ei=(0,o.useCallback)((e,t,n)=>{if(!(n>=60))return"".concat(e,"s-").concat(t,"s");{let n=Math.floor(t%60);return"".concat(Math.floor(e/60),":").concat(Math.floor(e%60).toString().padStart(2,"0"),"-").concat(Math.floor(t/60),":").concat(n.toString().padStart(2,"0"))}},[]),ec=(0,o.useCallback)((e,t)=>{let n=e.toLocaleTimeString("en-US",{hour12:!1,hour:"2-digit",minute:"2-digit"}),r=t.toLocaleTimeString("en-US",{hour12:!1,hour:"2-digit",minute:"2-digit"});return"".concat(n," - ").concat(r)},[]),es=(0,o.useCallback)(()=>{try{var t;let r={counts:e,log:n,videoSrc:S,intersections:E,playbackRate:x,currentTime:(null===(t=ea.current)||void 0===t?void 0:t.currentTime)||et,duration:er,lastSaved:Date.now(),recordingStartTime:null==J?void 0:J.toISOString(),videoCount:z,currentVideoIndex:Q,videoMetadata:X};localStorage.setItem(h,JSON.stringify(r)),console.log("Data saved to localStorage")}catch(e){console.error("Failed to save data to localStorage:",e)}},[e,n,S,E,x,et,er,J,z,Q,X]),eu=(0,o.useCallback)(()=>{try{let e=localStorage.getItem(h);if(e){let n=JSON.parse(e);if(Date.now()-n.lastSaved>6048e5)return console.log("Saved data is too old, starting fresh"),localStorage.removeItem(h),!1;if(n.videoSrc&&(n.log.length>0||n.intersections.length>0))return P(n),V(!0),t(n.counts||m),v(n.log||[]),w(n.intersections||[]),T(n.playbackRate||1),en(n.currentTime||0),eo(n.duration||0),B(n.recordingStartTime?new Date(n.recordingStartTime):null),K(n.videoCount||1),W(n.currentVideoIndex||0),Y(n.videoMetadata||{}),!0;return t(n.counts||m),v(n.log||[]),p(n.videoSrc||null),w(n.intersections||[]),T(n.playbackRate||1),en(n.currentTime||0),eo(n.duration||0),B(n.recordingStartTime?new Date(n.recordingStartTime):null),K(n.videoCount||1),W(n.currentVideoIndex||0),Y(n.videoMetadata||{}),console.log("Data loaded from localStorage"),!0}}catch(e){console.error("Failed to load data from localStorage:",e),localStorage.removeItem(h)}return!1},[]),ed=(0,o.useCallback)(()=>{try{localStorage.removeItem(h),console.log("Saved data cleared")}catch(e){console.error("Failed to clear saved data:",e)}},[]),eg=(0,o.useCallback)(e=>{U&&(p(URL.createObjectURL(e)),A(!0),V(!1))},[U]),em=(0,o.useCallback)(()=>{V(!1),P(null),ed()},[ed]);(0,o.useEffect)(()=>{eu(),M(!0)},[eu]),(0,o.useEffect)(()=>{if(D)return es(),el.current&&clearInterval(el.current),el.current=setInterval(es,5e3),()=>{el.current&&clearInterval(el.current)}},[e,n,S,E,x,es,D,J,z,Q,X,$]),(0,o.useEffect)(()=>{if(!D)return;let e=()=>{es()},t=()=>{"hidden"===document.visibilityState&&es()};return window.addEventListener("beforeunload",e),document.addEventListener("visibilitychange",t),()=>{window.removeEventListener("beforeunload",e),document.removeEventListener("visibilitychange",t)}},[es,D]),(0,o.useEffect)(()=>{let e=ea.current;if(!e)return;let t=()=>{y(!1),q(!0)};return e.addEventListener("ended",t),()=>{e.removeEventListener("ended",t)}},[S]);let eh=(0,o.useCallback)(function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:f.INTERVAL_SIZE_SECONDS;if(0===e.length)return[];console.log("Grouping data by ".concat(t,"s intervals"));let n={},r={};return e.forEach(e=>{r[e.videoIndex]||(r[e.videoIndex]=[]),r[e.videoIndex].push(e)}),Object.entries(r).forEach(e=>{var r;let[o,a]=e,l=Number.parseInt(o),i=a.map(e=>e.timestamp),c=Math.floor(Math.min(...i)/t)*t,s=Math.floor(Math.max(...i)/t)*t,u=null===(r=X[l])||void 0===r?void 0:r.recordingStartTime;for(let e=c;e<=s;e+=t){let r,o,a;let i=e+t,c="".concat(l,"-").concat(e);u?(o=new Date(u.getTime()+1e3*e),a=new Date(u.getTime()+1e3*i),r="Video ".concat(l+1,": ").concat(ec(o,a))):r="Video ".concat(l+1,": ").concat(ei(e,i,t)),n[c]={interval:r,startTime:e,endTime:i,directions:g.hj.reduce((e,t)=>({...e,[t.name]:0}),{}),totalCount:0,actualStartTime:o,actualEndTime:a,videoIndex:l}}a.forEach(e=>{let r=Math.floor(e.timestamp/t)*t,o="".concat(e.videoIndex,"-").concat(r),a=g.hj.find(t=>t.key===e.key);a&&n[o]&&(n[o].directions[a.name]++,n[o].totalCount++)})}),Object.values(n).sort((e,t)=>e.videoIndex!==t.videoIndex?e.videoIndex-t.videoIndex:e.startTime-t.startTime)},[X,ei,ec]),ef=(0,o.useCallback)(n=>{var r,o;let a=g.hj.find(e=>e.key===n);if(!a||!S||4!==E.length)return;let l=null!==(o=null===(r=ea.current)||void 0===r?void 0:r.currentTime)&&void 0!==o?o:0;v(e=>[...e,{key:n,timestamp:l,videoIndex:Q}]);let i=(e[a.name]||0)+1;t(e=>({...e,[a.name]:i})),k({key:n,direction:a.direction})},[e,S,E.length,Q]),ev=(0,o.useCallback)(()=>{if(0===n.length){k(null);return}let e=n[n.length-1],r=g.hj.find(t=>t.key===e.key);r&&t(e=>({...e,[r.name]:Math.max(0,e[r.name]-1)}));let o=n.slice(0,-1);if(v(o),o.length>0){let e=o[o.length-1],t=g.hj.find(t=>t.key===e.key);t?k({key:e.key,direction:t.direction}):k(null)}else k(null)},[n]),eS=(0,o.useCallback)(()=>{p(null),w([]),t(m),v([]),y(!1),T(1),k(null),en(0),eo(0),B(null),K(1),W(0),Y({}),ed()},[ed]),ep=(0,o.useCallback)((e,t)=>new Promise((n,r)=>{try{if(console.log("Starting CSV export with ".concat(e.length," entries")),0===e.length){console.warn("No data to export"),r(Error("No data to export"));return}let o=e.map(e=>{let t=[1,2,3,4,5,6,7,8].map(t=>{let n=g.hj.find(e=>e.key===t.toString());return n&&e.directions[n.name]||0});return[e.interval,...t].join(",")}),a=["Time interval,1,2,3,4,5,6,7,8",...o].join("\n");console.log("CSV content generated: ".concat(a.length," characters"));let l=new Blob([a],{type:"text/csv;charset=utf-8;"}),i=document.createElement("a"),c=URL.createObjectURL(l);i.setAttribute("href",c),i.setAttribute("download",t),i.style.visibility="hidden",document.body.appendChild(i),requestAnimationFrame(()=>{try{i.click(),console.log("CSV download triggered: ".concat(t)),setTimeout(()=>{document.body.removeChild(i),URL.revokeObjectURL(c),n()},100)}catch(e){console.error("Error clicking download link:",e),document.body.removeChild(i),URL.revokeObjectURL(c),r(e)}})}catch(e){console.error("Error creating CSV download:",e),r(e)}}),[]),eb=(0,o.useCallback)(()=>{if(0===n.length){console.warn("No log entries to export");return}if($){console.log("Export already in progress");return}ee(!0),console.log("Processing ".concat(n.length," log entries for export"));let e=eh(n);console.log("Generated ".concat(e.length," grouped entries")),N(e),I(!0)},[n,eh,$]),ek=(0,o.useCallback)(async()=>{if(console.log("Export complete triggered from modal"),0===L.length){console.error("No grouped data available for export"),ee(!1),I(!1);return}try{let n;let r=new Date().toISOString().slice(0,19).replace(/:/g,"-");if(Math.floor(f.INTERVAL_SIZE_SECONDS/60)>=1||f.INTERVAL_SIZE_SECONDS,Object.keys(X).length>0){var e;let t=null===(e=X[0])||void 0===e?void 0:e.recordingStartTime;if(t){let e=t.toISOString().slice(0,10);n="pedestrian_counts_".concat(e,"_").concat(r,".csv")}else n="pedestrian_counts_".concat(r,".csv")}else n="pedestrian_counts_".concat(r,".csv");console.log("Attempting to download CSV: ".concat(n)),await ep(L,n),console.log("CSV download completed successfully"),p(null),w([]),t(m),v([]),y(!1),T(1),k(null),en(0),eo(0),B(null),K(1),W(0),Y({}),N([]),ed(),console.log("All data cleared after successful export")}catch(e){console.error("Failed to export CSV:",e),ee(!1);return}ee(!1),I(!1)},[L,ep,X,ed]),eC=(0,o.useCallback)(()=>{if(ea.current)try{ea.current.paused?ea.current.play():ea.current.pause()}catch(e){console.error("Error toggling video playback:",e)}},[]),ey=(0,o.useCallback)(e=>{if(ea.current)try{let t=Math.max(.25,Math.min(4,e));ea.current.playbackRate=t,T(t)}catch(e){console.error("Error changing playback rate:",e)}},[]),ex=(0,o.useCallback)(e=>{if(Q>=0&&(E.length>0||J)&&Y(e=>({...e,[Q]:{recordingStartTime:J,intersections:[...E]}})),p(e),e){let e=X[Q];if(e)w(e.intersections),B(e.recordingStartTime);else{let e=Math.max(0,Q-1),t=X[e];t&&4===t.intersections.length?(w(t.intersections),console.log("Reusing intersections from video ".concat(e))):w([]),B(null),H(!0)}y(!1),T(1),en(0),eo(0),k(null)}},[Q,E,J,X]),eT=(0,o.useCallback)(()=>{q(!1),Q>=0&&Y(e=>({...e,[Q]:{recordingStartTime:J,intersections:[...E]}})),W(z),K(e=>e+1);let e=document.getElementById("video-upload-hidden");null==e||e.click()},[z,Q,J,E]),eE=(0,o.useCallback)(()=>{q(!1),eb()},[eb]),ew=(0,o.useCallback)(()=>{q(!1),ea.current&&(ea.current.currentTime=0,en(0))},[]),ej=(0,o.useCallback)(e=>{B(e),H(!1),Y(t=>({...t,[Q]:{recordingStartTime:e,intersections:[...E]}}))},[Q,E]),eI=(0,o.useCallback)(()=>{B(null),H(!1),Y(e=>({...e,[Q]:{recordingStartTime:null,intersections:[...E]}}))},[Q,E]),eL=(0,o.useCallback)(()=>{ea.current&&en(ea.current.currentTime)},[]),eN=(0,o.useCallback)(()=>{if(ea.current){if(eo(ea.current.duration),Z&&U){let e=U.currentTime;e&&e>0&&(ea.current.currentTime=e,en(e),console.log("Video restored to time: ".concat(e,"s"))),A(!1),P(null)}else{let e=localStorage.getItem(h);if(e)try{let t=JSON.parse(e);t.currentTime&&t.currentTime>0&&!t.videoSrc&&(ea.current.currentTime=t.currentTime,en(t.currentTime))}catch(e){console.error("Failed to restore video time on fresh load:",e)}}}},[Z,U]),eO=(0,o.useCallback)(e=>{ea.current&&(ea.current.currentTime=e,en(e))},[]),eR=(0,o.useCallback)(()=>{R(!0)},[]),eD=(0,o.useCallback)(e=>{w(e),Y(t=>({...t,[Q]:{recordingStartTime:J,intersections:[...e]}}))},[Q,J]);if((0,o.useEffect)(()=>{let e=e=>{var t;if(e.target instanceof HTMLInputElement||e.target instanceof HTMLTextAreaElement||e.target instanceof HTMLSelectElement||(null===(t=e.target)||void 0===t?void 0:t.closest("input, textarea, select, [contenteditable]")))return;let n=e.key.toLowerCase(),r=e.key.replace("numpad","");g.hj.some(e=>e.key===r)&&4===E.length?(e.preventDefault(),e.stopPropagation(),ef(r)):"z"===n?(e.preventDefault(),e.stopPropagation(),ev()):" "===n&&S?(e.preventDefault(),e.stopPropagation(),eC()):"?"===n||e.shiftKey&&"/"===n?(e.preventDefault(),e.stopPropagation(),R(e=>!e)):"arrowleft"===n&&S?(e.preventDefault(),e.stopPropagation(),ey(Math.max(.25,x-.25))):"arrowright"===n&&S&&(e.preventDefault(),e.stopPropagation(),ey(Math.min(4,x+.25)))};return document.addEventListener("keydown",e,{capture:!1}),()=>{document.removeEventListener("keydown",e,{capture:!1})}},[ef,ev,S,eC,E.length,x,ey]),!D)return(0,r.jsx)("div",{className:"h-screen w-screen bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-800 flex items-center justify-center",children:(0,r.jsxs)("div",{className:"text-center",children:[(0,r.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),(0,r.jsx)("p",{className:"text-slate-600 dark:text-slate-300",children:"Loading saved data..."})]})});let eM=Object.values(e).reduce((e,t)=>e+t,0),e_=b?(()=>{let t=g.hj.find(e=>e.key===b.key);return t&&e[t.name]||0})():0;return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("main",{className:"h-screen w-screen bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-800 flex flex-col p-4 gap-0 overflow-hidden transition-all duration-300 ".concat(O?"pr-84":""),children:[(0,r.jsx)("div",{className:"flex-grow h-full min-h-0",children:(0,r.jsx)(a.Z,{ref:ea,videoSrc:S,onVideoSelect:ex,onPlay:()=>y(!0),onPause:()=>y(!1),lastPressed:b,onIntersectionsSet:eD,onTimeUpdate:eL,onLoadedMetadata:eN})}),(0,r.jsx)("div",{className:"flex-shrink-0",children:(0,r.jsx)(l.Z,{isPlaying:C,playbackRate:x,onTogglePlay:eC,onChangePlaybackRate:ey,isVideoLoaded:!!S,onUndo:ev,onFinish:eb,onClearVideo:eS,canUndo:n.length>0,canFinish:n.length>0,currentTime:et,duration:er,onSeek:eO,onShowHelp:eR,lastPressed:b,intersectionsSet:4===E.length,totalCount:eM,lastDirectionCount:e_})})]}),(0,r.jsx)(u.Z,{isOpen:F,onConfirm:ej,onSkip:eI}),(0,r.jsx)(d.Z,{isOpen:G,onUploadNew:eT,onExport:eE,onReplay:ew,totalCounts:eM,videoCount:z}),(0,r.jsx)(i.Z,{isOpen:j,onComplete:ek,totalEntries:n.length,groupedEntries:L.length}),(0,r.jsx)(c.Z,{isOpen:O,onClose:()=>R(!1),onCount:ef,onUndo:ev,intersectionsSet:4===E.length,canUndo:n.length>0}),_&&U&&(0,r.jsx)(s.Z,{isOpen:_,onVideoRestore:eg,onDismiss:em,savedData:{currentTime:U.currentTime,duration:U.duration,totalCounts:eM,intersectionCount:U.intersections.length,lastSaved:U.lastSaved}}),(0,r.jsx)("input",{type:"file",id:"video-upload-hidden",accept:"video/mp4, video/webm, video/ogg",style:{display:"none"},onChange:e=>{var t;let n=null===(t=e.target.files)||void 0===t?void 0:t[0];n&&ex(URL.createObjectURL(n)),e.target.value=""}})]})}}},function(e){e.O(0,[533,367,971,117,744],function(){return e(e.s=1214)}),_N_E=e.O()}]);